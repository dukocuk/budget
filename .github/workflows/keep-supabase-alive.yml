name: Keep Supabase Active

on:
  schedule:
    # Runs at 9:00 AM UTC every Monday and Thursday
    # This prevents Supabase free tier from pausing after 7 days of inactivity
    - cron: '0 9 * * 1,4'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Database
        run: |
          echo "Pinging Supabase database to prevent inactivity pause..."

          # Make a lightweight query to the expenses table
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/expenses?limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}")

          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n1)

          # Check if request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "✅ Successfully pinged Supabase database (HTTP $http_code)"
            echo "Database will remain active for another 7 days"
          else
            echo "❌ Failed to ping Supabase (HTTP $http_code)"
            echo "Response: $(echo "$response" | head -n-1)"
            exit 1
          fi

      - name: Log Timestamp
        run: |
          echo "Keep-alive executed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
